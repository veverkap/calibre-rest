//go:build ignore

// To run: go run generate.go
package main

import (
	"bytes"
	"encoding/json"
	"fmt"
	"os"
	"strings"

	"github.com/samber/lo"
)

func main() {
	// read calibre_cli_options.json
	jsonData, err := os.ReadFile("/Users/veverkap/Code/personal/calibre-rest/calibredb_cli_options.json")
	if err != nil {
		panic(err)
	}
	// unmarshal jsonData into map[string]Command
	commands := make(map[string]Command)
	err = json.Unmarshal(jsonData, &commands)
	if err != nil {
		panic(err)
	}

	for name, cmd := range commands {
		var out bytes.Buffer
		fmt.Println("Processing ", name)

		name = strings.Replace(name, "cmd_", "", 1)
		pascalCmd := lo.PascalCase(name)
		structName := pascalCmd + "Options"

		fmt.Println("Generating struct", structName)

		out.WriteString("// Code generated by generate.go; DO NOT EDIT.\n")
		for _, line := range strings.Split(cmd.UsageText, "\n") {
			out.WriteString("// " + line + "\n")
		}
		out.WriteString("package generated\n\n")
		out.WriteString("type " + structName + " struct {\n")
		// for _, option := range cmd.Options {
		// 	fieldName := lo.PascalCase(strings.TrimLeft(option.Dest, "-"))
		// 	jsonTag := strings.ReplaceAll(option.Dest, "_", "-")
		// 	var fieldType string
		// 	switch option.Type {
		// 	case "string":
		// 		fieldType = "string"
		// 	case "int":
		// 		fieldType = "int"
		// 	case "bool":
		// 		fieldType = "bool"
		// 	default:
		// 		fieldType = "string"
		// 	}
		// 	out.WriteString(fmt.Sprintf("\t%s %s `json:\"%s,omitempty\"` // %s\n", fieldName, fieldType, jsonTag, strings.ReplaceAll(option.Help, "\n", " ")))
		// }
		out.WriteString("}\n")
		err := os.WriteFile(fmt.Sprintf("generated/%s.go", name), out.Bytes(), 0644)
		if err != nil {
			panic(err)
		}
	}
}

type Options struct {
	File         string   `json:"_file"`
	Line         int      `json:"_line"`
	Action       string   `json:"action"`
	CallbackArgs string   `json:"callback_args"`
	Callback     string   `json:"callback"`
	Default      any      `json:"default"`
	Dest         string   `json:"dest"`
	Metavar      string   `json:"metavar"`
	Nargs        int      `json:"nargs"`
	Type         string   `json:"type"`
	Help         string   `json:"help"`
	Flags        []string `json:"flags"`
}
type Command struct {
	File         string    `json:"file"`
	UsageText    string    `json:"usage_text"`
	Options      []Options `json:"options"`
	OptionGroups []any     `json:"option_groups"`
}
